# Состояние UI (HUD) — Astra

Этот документ описывает текущий HUD (Tauri + React) и то, как он отображает `Run/Plan/Task/Event` из API (`/api/v1`) и SSE.

## Структура экрана

- `IdleScreen`: стартовый экран с брендом **Astra**, вопросом и одним полем ввода + круглой кнопкой отправки внутри поля.
- `RunScreen`: «трек» выполнения. Показывает цель, текущий фокус, план, блок автопилота и агрегированный журнал событий.
- `ConfirmModal`: модальное подтверждение (confirm gate). Не ломает run, `Esc` скрывает модалку.
- `SettingsPanel`: настройки (модель + ключ, режим запуска, визуальные переключатели). Открывается через шестерёнку в HUD.
- `TopHoverBar`: верхняя панель появляется при наведении курсора в верхнюю зону. Там же зона перетаскивания окна (drag).

## Состояния

UI использует фазу, которая собирается из `run.status`, pending approvals и `autopilot_state`:

- `idle`: до запроса (нет активного run).
- `thinking`: run создан/планируется или `autopilot_state.phase = thinking`.
- `executing`: активное выполнение (план/задачи/автопилот «делает»).
- `waiting_confirm`: есть `Approval(status=pending)` или `autopilot_state.status` требует подтверждения/действия.
- `done`: `run.status in (done, failed, canceled)`.

## Горячие клавиши (macOS)

- `Esc`: если открыты настройки, закрывает их; если есть модальное подтверждение, скрывает его; иначе прячет окно.
- `Cmd+W`: прячет окно (HUD).
- `Cmd+Q`: выход из приложения.
- `Cmd+Shift+O`: переключение режимов окна (`overlay` / `window`).
- `Cmd+Shift+S`: «Стоп» (отмена текущего run).

## Данные и поток

- Snapshot: `GET /api/v1/runs/{id}/snapshot` — основной источник `run/plan/tasks/approvals/metrics/last_events`.
- SSE: `GET /api/v1/runs/{id}/events?token=...&last_event_id=...` — живые события.
- Поведение при обрыве SSE:
  - включается fallback polling snapshot (раз в ~4.5с);
  - параллельно запускается reconnect с backoff + jitter.
- События в HUD:
  - `autopilot_state`/`autopilot_action` берутся из `payload` и показываются отдельным блоком;
  - остальные события агрегируются (склейка подряд идущих одинаковых сообщений), чтобы не спамить лог.

## Smoke тест (ручной)

1. Запусти всё одной командой: `./scripts/run.sh`
2. Открой HUD, нажми шестерёнку, сохрани OpenAI ключ (один раз).
3. В Idle введи запрос, например:
   - «Астра, возьми мои “Мне нравится” в Яндекс Музыке… создай плейлист… для каждого трека короткое обоснование.»
4. Проверь:
   - Astra разбивает задачу на шаги (план) и показывает активный шаг;
   - события идут живьём (SSE), при обрыве поток восстанавливается;
   - при опасных действиях появляется модальное подтверждение.


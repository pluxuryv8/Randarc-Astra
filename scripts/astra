#!/usr/bin/env bash
set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
ROOT_DIR="$(cd "$SCRIPT_DIR/.." && pwd)"
cd "$ROOT_DIR"

# shellcheck disable=SC1091
source "$ROOT_DIR/scripts/lib/address_config.sh"

if ! apply_resolved_address_env; then
  echo "FAIL Некорректная адресная конфигурация (API/Bridge)." >&2
  exit 1
fi

CMD="${1:-dev}"
if [ $# -gt 0 ]; then
  shift
fi

API_PORT="$ASTRA_API_PORT"
BRIDGE_PORT="$ASTRA_BRIDGE_PORT"
VITE_PORT=5173
OLLAMA_PORT=11434
OLLAMA_FLASH_ATTENTION_DESIRED="${ASTRA_OLLAMA_FLASH_ATTENTION:-0}"
OLLAMA_RESTART_ON_ENV_MISMATCH="${ASTRA_OLLAMA_RESTART_ON_ENV_MISMATCH:-true}"

PIDS_DIR="$ROOT_DIR/.astra/pids"
LOG_BASE="$ROOT_DIR/artifacts/dev_logs"
LATEST_LOG_FILE="$ROOT_DIR/.astra/dev_logs/latest"

mkdir -p "$PIDS_DIR"
mkdir -p "$(dirname "$LATEST_LOG_FILE")"

ok() { echo "OK  $*"; }
warn() { echo "WARN $*"; }
fail() { echo "FAIL $*"; }

port_listening() {
  local port="$1"
  lsof -nP -iTCP:"$port" -sTCP:LISTEN -t >/dev/null 2>&1
}

kill_port_listeners() {
  local port="$1"
  local label="$2"
  local pids
  pids="$(lsof -nP -iTCP:"$port" -sTCP:LISTEN -t 2>/dev/null || true)"
  if [ -n "$pids" ]; then
    kill $pids >/dev/null 2>&1 || true
    ok "$label: освобождён порт $port"
  fi
}

wait_port() {
  local port="$1"
  local label="$2"
  local tries="${3:-40}"
  local delay="${4:-0.25}"
  for _ in $(seq 1 "$tries"); do
    if port_listening "$port"; then
      ok "$label (порт $port)"
      return 0
    fi
    sleep "$delay"
  done
  warn "$label не поднялся (порт $port)"
  return 1
}

write_pid() {
  local name="$1"
  local pid="$2"
  if [ -n "$pid" ]; then
    echo "$pid" > "$PIDS_DIR/$name.pid"
  fi
}

read_pid() {
  local name="$1"
  local file="$PIDS_DIR/$name.pid"
  if [ -f "$file" ]; then
    cat "$file"
  fi
}

start_ollama() {
  local log_dir="$1"

  if port_listening "$OLLAMA_PORT"; then
    local running_pid
    local running_cmd
    local running_flash
    local mismatch_allowed

    running_pid="$(lsof -nP -iTCP:"$OLLAMA_PORT" -sTCP:LISTEN -t 2>/dev/null | head -n1 || true)"
    running_cmd="$(ps eww -p "$running_pid" -o command= 2>/dev/null || true)"
    running_flash="$(echo "$running_cmd" | sed -nE 's/.*OLLAMA_FLASH_ATTENTION=([^ ]+).*/\1/p')"
    mismatch_allowed="$OLLAMA_RESTART_ON_ENV_MISMATCH"

    if [ -n "$running_flash" ] && [ "$running_flash" != "$OLLAMA_FLASH_ATTENTION_DESIRED" ] && [[ ! "$mismatch_allowed" =~ ^(0|false|no|off)$ ]]; then
      warn "Ollama запущена с OLLAMA_FLASH_ATTENTION=${running_flash}, перезапуск в ${OLLAMA_FLASH_ATTENTION_DESIRED}"
      if [[ "$running_cmd" == *"homebrew.mxcl.ollama"* ]] && command -v brew >/dev/null 2>&1; then
        brew services stop ollama >/dev/null 2>&1 || true
      fi
      kill "$running_pid" >/dev/null 2>&1 || true
      for _ in $(seq 1 40); do
        if ! port_listening "$OLLAMA_PORT"; then
          break
        fi
        sleep 0.25
      done
    else
      ok "Ollama уже запущена (порт $OLLAMA_PORT)"
      return 0
    fi
  fi

  if command -v ollama >/dev/null 2>&1; then
    OLLAMA_FLASH_ATTENTION="$OLLAMA_FLASH_ATTENTION_DESIRED" nohup ollama serve >"$log_dir/ollama.log" 2>&1 &
    write_pid "ollama" "$!"
    if wait_port "$OLLAMA_PORT" "Ollama"; then
      ok "Ollama поднята локально (OLLAMA_FLASH_ATTENTION=${OLLAMA_FLASH_ATTENTION_DESIRED})"
      return 0
    fi
    warn "Ollama не поднялась после запуска. Проверь лог: $log_dir/ollama.log"
    return 1
  fi

  warn "Ollama не найдена. Установите ollama или запустите вручную."
  return 1
}

start_stack() {
  local ts
  ts="$(date +"%Y%m%d-%H%M%S")"
  local log_dir="$LOG_BASE/$ts"
  mkdir -p "$log_dir"
  echo "$log_dir" > "$LATEST_LOG_FILE"

  if port_listening "$BRIDGE_PORT" && ! port_listening "$VITE_PORT"; then
    warn "Найден stale bridge без Vite. Очищаю порт ${BRIDGE_PORT} перед запуском."
    kill_port_listeners "$BRIDGE_PORT" "Bridge"
  fi

  start_ollama "$log_dir" || true

  ASTRA_AUTH_MODE="${ASTRA_AUTH_MODE:-local}" ASTRA_LOG_DIR="$log_dir" ./scripts/run.sh --background

  if [ -f .astra/api.pid ]; then
    write_pid "api" "$(cat .astra/api.pid)"
  fi
  if [ -f .astra/tauri.pid ]; then
    write_pid "desktop" "$(cat .astra/tauri.pid)"
  fi

  wait_port "$API_PORT" "API"
  wait_port "$VITE_PORT" "Vite"
  wait_port "$BRIDGE_PORT" "Bridge"

  ok "Готово. Логи: $log_dir"
}

status_ports() {
  if port_listening "$OLLAMA_PORT"; then ok "Ollama: слушает $OLLAMA_PORT"; else warn "Ollama: нет"; fi
  if port_listening "$API_PORT"; then ok "API: слушает $API_PORT"; else warn "API: нет"; fi
  if port_listening "$VITE_PORT"; then ok "Vite: слушает $VITE_PORT"; else warn "Vite: нет"; fi
  if port_listening "$BRIDGE_PORT"; then ok "Bridge: слушает $BRIDGE_PORT"; else warn "Bridge: нет"; fi
}

status_pids() {
  for name in ollama api desktop; do
    local pid
    pid="$(read_pid "$name" || true)"
    if [ -n "$pid" ]; then
      if kill -0 "$pid" >/dev/null 2>&1; then
        ok "pid $name: $pid"
      else
        warn "pid $name: $pid (не активен)"
      fi
    else
      warn "pid $name: нет"
    fi
  done
  if [ -f "$PIDS_DIR/ollama.service" ]; then
    ok "ollama.service: brew"
  fi
}

do_status() {
  status_ports
  status_pids
  if [ -f "$LATEST_LOG_FILE" ]; then
    echo "LOGS: $(cat "$LATEST_LOG_FILE")"
  fi
  echo "Для диагностики: ./scripts/astra doctor"
}

do_stop() {
  local stopped=0
  for name in desktop api ollama; do
    local pid_file="$PIDS_DIR/$name.pid"
    if [ -f "$pid_file" ]; then
      local pid
      pid="$(cat "$pid_file")"
      if [ -n "$pid" ]; then
        kill "$pid" >/dev/null 2>&1 || true
        stopped=1
      fi
      rm -f "$pid_file"
    fi
  done

  if [ -f "$PIDS_DIR/ollama.service" ]; then
    if command -v brew >/dev/null 2>&1; then
      brew services stop ollama >/dev/null 2>&1 || true
    fi
    rm -f "$PIDS_DIR/ollama.service"
  fi

  kill_port_listeners "$BRIDGE_PORT" "Bridge"
  kill_port_listeners "$VITE_PORT" "Vite"
  kill_port_listeners "$API_PORT" "API"

  if [ "$stopped" -eq 0 ]; then
    ./scripts/stop.sh || true
  fi
}

do_logs() {
  if [ ! -f "$LATEST_LOG_FILE" ]; then
    warn "Логи не найдены."
    exit 1
  fi
  local log_dir
  log_dir="$(cat "$LATEST_LOG_FILE")"
  echo "LOGS: $log_dir"
  local target="${1:-}"
  if [ -z "$target" ]; then
    ls -1 "$log_dir"
    return 0
  fi
  local file=""
  case "$target" in
    api)
      file="$log_dir/api.log"
      ;;
    desktop|tauri|vite)
      file="$log_dir/tauri.log"
      ;;
    ollama)
      file="$log_dir/ollama.log"
      ;;
  esac
  if [ -z "$file" ]; then
    warn "Неизвестный лог: $target"
    exit 1
  fi
  if [ -f "$file" ]; then
    tail -n 200 "$file"
  else
    warn "Файл логов не найден: $file"
  fi
}

case "$CMD" in
  dev)
    start_stack
    ;;
  stop)
    do_stop
    ;;
  status)
    do_status
    ;;
  logs)
    do_logs "${1:-}"
    ;;
  doctor)
    ./scripts/doctor.sh runtime
    ;;
  smoke)
    ./scripts/smoke.sh
    ;;
  restart)
    do_stop
    start_stack
    ;;
  *)
    echo "Usage: scripts/astra [dev|stop|status|logs|doctor|smoke|restart]"
    exit 1
    ;;
esac
